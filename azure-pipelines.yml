trigger:
- test-azure
- master
- release/*

jobs:
  # Linux
  - job: Linux
    pool:
      vmImage: 'ubuntu-16.04'
    steps:
    - bash: |
        pypath=`which python3`
        ${pypath} -m pip install setuptools
        ${pypath} -m pip install -r requirements-frozen.txt
        ${pypath} setup.py sdist
      displayName: 'Build for python 3'

  # macOS
  - job: macOS
    pool:
      vmImage: 'macos-10.13'
    steps:
    - bash: |
        wget https://www.python.org/ftp/python/3.7.3/python-3.7.3-macosx10.9.pkg
        sudo installer -pkg python-3.7.3-macosx10.9.pkg -target /
      displayName: 'Install all pythons'
    - bash: |
        pypath=`which python3.7`
        ${pypath} -m pip install -r requirements-frozen.txt
        ${pypath} setup.py sdist
      displayName: 'Build for python 3.7'

  # Windows
  - job: Windows
    strategy:
      matrix:
        win64:
          python_arch: 'x64'
    pool:
      vmImage: 'vs2017-win2016'
    steps:
    - task: UsePythonVersion@0
      inputs:
        versionSpec: '3.7'
        architecture: '$(python_arch)'
    - bash: |
        pip install -r requirements-frozen.txt
        python setup.py sdist
      displayName: 'Build tar.gz for python 3.7'
    - bash: |
        pip install pyinstaller
        pyinstaller nrfutil.spec
      displayName: 'Build exe for python 3.7'
    - bash: |
        cp -R dist/*.tar.gz "$(Build.ArtifactStagingDirectory)"
        cp -R dist/*.exe "$(Build.ArtifactStagingDirectory)"
      displayName: 'Copy artifacts'
    - task: GitHubRelease@0
      inputs:
        gitHubConnection: 'waylandCI'
        repositoryName: 'NordicSemiconductor/pc-nrfutil'
        action: 'edit'
        tagSource: 'Git tag'
        tag: '$(Build.SourceBranchName)'
        assetUploadMode: 'replace'
        isDraft: 'true'
        addChangeLog: 'false'
      condition: ne(variables['Build.Reason'], 'PullRequest')
